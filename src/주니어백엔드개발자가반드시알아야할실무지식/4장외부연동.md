## 4장 외부연동이 문제일 때 살펴봐야 할 것들
마이크로 서비스 되면서 내부, 외부 연동이 많아짐. 

예시) 자체 서비스는 트래픽 감당이 되는데, 외부 서비스가 트래픽 감당이 안되서 문제가 생김. 

연동 서비스가 많아질수록 연동 서비스의 품질 관리도 신경 써야한다. - 다만, 100% 차단하긴 어렵다. 대신 영향도는 줄여보자. 

## 타임아웃
A서비스는 B서비스를 호출하는데 타임아웃 설정없이 B서비스의 응답이 60초로 늘어났다. 

만약 타임아웃 설정을 안해서 스레드가 남지 않은 상황에서, 외부 연동이 필요 없는 호출이 추가로 들어온다면... 골치아파진다.

타임아웃 설정이 되어있으면, 스레드가 모자라는 일이 줄어든다. 

### 타임아웃 종류
외부 연동을 단순화하면 연결, 요청, 응답, 종료 4단계이다

연결 타임아웃 시간을 설정하자.(3~5초)

응답 대기시간도 타임아웃 설정하자.(5~30초)

2중으로 연결한 경우 : 커머스 서비스 <-> PG서버 <-> 카드가

타임아웃을 너무 짧게 잡을 경우 카드사는 pg서버에게 정상 응답해서 pg에서는 결제가 되었는데, 
커머스 서비스는 카드사가 늦게 준다고 생각해서 타임아웃 에러를 냄
이로 인해서 결제는 되었는데 상품 구매는 안되는 상황이 발생할 수 있음.

이런 상황을 고려해서 타임아웃을 길게 잡는 것이 필요할 때도 있음. 

///
소캣 타임아웃: 패킷 호출 간격에 대한 타임아웃 설정임. 
호출 타임아웃: 총 응답 시간에 대한 타임아웃임. 
호출 = 패킷들의 합

## 재시도
간헐적인 늦음 현상이 생길수도 있다. 이럴 때 재시도를 통해서 성공시켜보자.

다만 연동 api를 다시 호출해도 되는 조건인지 확인이 필요하다. 

가령 포인트 차감을 하는 외부 api호출을 할 때, 잘못하면 2번 차감될 수도 있다.(늦더라도 포인트 차감은 실행될 수 있으므로) 

### 재시도 가능한 경우
- 단순 조회 기능
- 연결 타임아웃
- 멱등성을 가진 변경 기능

그리고 같은 api라도 실패 원인에 따라서 재시도 요청을 해야한다.
만약 검증 오류 등으로 인해 실패하면 재시도 해도 마찬가지로 실패할 것이다. 

재시도 횟수: 1~2번이 적당함(총 3번하는 것임)
재시도 간격: 지수적으로 대기시간을 늘리면서 해볼 수 있다. 바로 연달아 하지만 말자.  

만약 연동 서비스가 요청 폭풍으로 인해서 늦어진 상황인데 재시도를 계속해서 한다면 그것도 문제가 된다.
그래서 연동 서비스의 상황과 체격을 고려해서 재시도 정책을 세워야 한다. 

## 동시요청 제한
연동 서비스의 처리 한계량을 명확하게 알자. 그 이상은 보내지 말자. 

## 서킷 브레이커
연동 서비스가 맛이 갔을 때, 대체 서비스로 전환하거나 아예 에러 화면을 바로 보여주는 것이 낫다

닫힘, 열림, 반열림 3가지 상태를 가진다. 닫힘이 비활성화된 것임. 실패 건수가 임계치를 넘어서면 열리면서 활성화된다. 

시간 기준 오류 발생 비율: 10초 요청 중 50%
개수 기준 오류 발생 비율: 100개 중 50%

열림 상태를 지정된 상태동안 유지하다가, 반열림 상태로 전환함. 반 열려서 일부 요청에 대해서 다시 시도해봄. 
일부 시간 혹은 갯수 동안 반열림 상태 유지하다가 닫힘 혹은 열림 판단을 한다. 

서킷 브레이커가 열려있는 동안 연동 서비스가 과부하에서 벗어날 수 있기도 하다. 

## 외부 연동과 DB 연동 문제
외부 연동 실패시 트렌젝션 롤백은 괜춘
만약 읽기 타임아웃 실패시 트렌젝션 롤백은 이후 외부 api성공시를 고려해야함
이를 잡기 위해서 폴링으로 데이터 정합성 확인해야함. 
혹은 읽기 타임아웃 일정 시간 후 성공 확인 api를 호출해서 확인해보기. 혹은 취소 api호출해보기.

만약 외부 연동 성공했는데 내부 DB연결 실패시에는 취소 api호출하고, 재차 데이터 정합성 맞는지 확인해봐야한다. 

### db커넥션 풀
외부 연동시간이 길어져서 db커넥션 풀이 포화되는 것을 막으려면 외부 연동 전후로 db사용을 하고 트렌젝션을 끊는 것도 방법이다.
대신 이 방법을 쓰면 트렌젝션 롤백이 안되기 때문에 실패 처리를 다르게 해줘야한다. = 보상 트랜젝션, 데이터 후보정

## HTTP 커넥션 풀
너무 많이 생성하면 연동 서비스에 부하줄 수 있음
커넥션 풀 재사용시 연결 시간 고려

## 연동 서비스 이중화
해당 서비스가 핵심인지 여부
이중화 비용감담 여부







