# 동시성 문제의 큰 원인
공유자원에 대한 여러 스레드의 동시 접근
RaceCondition

자주 쓰는 spring은 안전할까?

bean은 싱글톤으로 만들어집니다. stateless하게 설계하기 때문에 멀티 스레드에서 안전

# 동시성 제어 방법
## 잠금을 이용한 접근 제어
가상스레드에서 synchronized를 쓰려면 24부터 쓰면 됩니다. 


많은 요청이 들어왔을 때, 동시에 처리하지 못하면 서버 성능에 장애가 생긴다.
하지만 또 동시에 처리하면 데이터에 문제가 생길 수도 있다. 

1) 클라이언트 요청마다 스레드 할당해서 처리
2) 비동기 IO를 사용해서 처리

race condition: 반복 시행, 동시 시행으로 인해서 결과가 달라지는 상황

## 잘못된 데이터 공유로 인한 문제 예시

### 세마포어
세마포어: 동시에 실행할 수 있는 스레드 갯수를 제한함. 
이진 세마포어(2개만 허용), 계수 세마포어
퍼밋 획득 -> 코드 실행 -> 퍼밋 반환

### 읽기 쓰기 잠금
읽기 잠금은 여러개, 쓰기 잠금은 하나로 둬보자. 
한 스레드가 쓰기 잠금을 획득했다면, 쓰기 잠금이 해제될 때까지 읽기 잠금을 구할 수 없다. 
읽기 잠금을 획득한 모든 스레드가 읽기 잠금을 해제할 때까지 쓰기 잠금을 구할 수 없다.

### 원자적 타입 사용
내부적으로 CAS 연산을 사용함. 

### 동시성 지원 컬렉션
hashMap, hashSet을 여러 스레드가 동시에 변경하면 데이터가 깨진다. 
Collections.synchronizedMap을 사용하면 동기화된 컬렉션 객체 생성 가능합니다.

가상스레드 사용 중이라면 자바 23 이전에는 쓰면 안된다. 내부적으로 synchronized를 사용하기 때문이다. 이로 인해서 가상 스레드의 이점을 못볼 수 있다.
아니면 concurrentHashMap을 써도 좋다. 

#### 불변값 사용해보자. 

## DB와 동시성
제약조건도 db의 동시성 처리중 하나이다!

db가 없었다고 생각해봐. 특히 트랜잭션을 통해서 데이터 다루는 과정에서 발생할 다양한 동시성 문제를 처리 가능하다. 

트렌젝션 안의 하나라도 실패하면 전체 롤백!

비관적 락과 낙관적 락에 대해서 알아보자. 

### 비관적 락(선점 락)


### 낙관적 락
비교 칼럼으로 변경할지 결정함

### 외부 연동과 잠금
외부 연동시에는 비관적 락을 고려하자. 
낙관적 락을 하면 다 해놓고 롤백하는 상황이 벌어질 수 있다. 

아니면 아예 아웃박스 패턴을 사용해서 커밋 이후에 메세지로 보내는 방법도 있다. 

### 증분 쿼리
raceCondition이 생기는 것을 방지해보자.  
이를 해결하기 위해서 비관적 락을 사용할 수도 있지만, db쿼리를 증분 쿼리 사용하면 원자적으로 계산해준다
```mysql
update subject set joinCount = joinCount + 1 where id = ?
```

## 잠금 사용 시 주의 사항
### 잠금 해제하기
잠금 해제하지 않으면 대기 스레드가 무한정 대기 ~~~
세마포어도 마찬가지임. 해제해줘야한다. 

잠금 해제는 무조건 finally로 하는 습관을 들이자. 

### 대기 시간 정하기
너무 오래 기다리지 않고 빠른 실패 하도록 Fast Fail 타임아웃 하자.

```java
import java.util.concurrent.TimeUnit;

boolean acquired = lock.tryLock(5, TimeUnit.SECONDS);
// 잠금 획득 실패
if(!acquired){
  에러 
}
try{
//자원 접근 코드 실행  
} finally{
  lock.unlock();  
}
```

### 데드락 피하기
A, B 잠금 이 둘다 필요한 트렌젝션을 개발하면, 

여러 프로세스에서 동시 실행시 둘 중에 하나를 얻지 못해서 교착되고 있으면서 자신이 가지고 있는 잠금은 반환하지 않아서 생기는 데드락 문제가 생길 수 있다.

이 문제 해결을 위해서도 타임아웃 설정을 해볼 수 있다. 

## 단일 스레드로 처리하기 
사실 스레드 하나만 쓰면 되긴 함 ㅋ 그럼 동시성 문제 없음 
다수의 작업 요청 스레드 - 작업큐 -> 상태 관리 스레드 

